<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Genius F5LE - Pro Sync</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #0a0a0a; color: #e0e0e0; text-align: center; padding: 20px; }
        .dashboard { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; max-width: 500px; margin: 20px auto; }
        .card { background: #1a1a1a; padding: 20px; border-radius: 15px; border-top: 4px solid #00f2fe; box-shadow: 0 4px 20px rgba(0,0,0,0.5); }
        .val { font-size: 2.5rem; color: #00f2fe; font-weight: bold; margin: 10px 0; }
        .unit { font-size: 0.8rem; color: #666; text-transform: uppercase; }
        button { background: linear-gradient(to right, #00f2fe, #4facfe); color: black; border: none; padding: 15px 40px; border-radius: 50px; font-weight: bold; cursor: pointer; font-size: 1rem; margin-top: 10px; }
        #log { font-family: monospace; font-size: 10px; color: #444; margin-top: 30px; text-align: left; height: 80px; overflow-y: auto; background: #000; padding: 10px; border-radius: 5px; }
    </style>
</head>
<body>

    <h2>Genius F5LE Pro Dashboard</h2>
    <p id="status" style="color: #00f2fe;">Status: Ready to Sync</p>
    <button id="syncBtn">CONNECT & UPLOAD DATA</button>

    <div class="dashboard">
        <div class="card"><div id="steps" class="val">0</div><div class="unit">Steps Today</div></div>
        <div class="card"><div id="hr" class="val">--</div><div class="unit">Live BPM</div></div>
        <div class="card"><div id="bp" class="val">--</div><div class="unit">Blood Pressure</div></div>
        <div class="card"><div id="batt" class="val">--</div><div class="unit">Battery %</div></div>
    </div>

    <div id="log">Waiting for user...</div>

    <script>
        const logger = (m) => { document.getElementById('log').innerHTML += `<div>> ${m}</div>`; };
        
        document.getElementById('syncBtn').onclick = async () => {
            try {
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ namePrefix: 'F5' }, { namePrefix: 'Genius' }],
                    optionalServices: ['0000fee7-0000-1000-8000-00805f9b34fb', 'battery_service', 'heart_rate']
                });

                const server = await device.gatt.connect();
                document.getElementById('status').innerText = "Status: DEEP CONNECTED";
                logger("Link Established.");

                // 1. Target the Fitness Service (FEE7)
                const fitService = await server.getPrimaryService('0000fee7-0000-1000-8000-00805f9b34fb');
                
                // 2. Start Listening for Data (FEC8)
                const readChar = await fitService.getCharacteristic('0000fec8-0000-1000-8000-00805f9b34fb');
                await readChar.startNotifications();
                readChar.addEventListener('characteristicvaluechanged', (e) => {
                    const data = e.target.value;
                    logger("Received packet: " + data.byteLength + " bytes");
                    
                    // PARSE DATA (Steps are usually bytes 1, 2, 3)
                    if (data.byteLength >= 4) {
                        const steps = (data.getUint8(1) << 16) | (data.getUint8(2) << 8) | data.getUint8(3);
                        if (steps > 0) document.getElementById('steps').innerText = steps.toLocaleString();
                    }
                    // Health data (HR / BP) usually follow in larger packets
                    if (data.byteLength >= 10) {
                        document.getElementById('hr').innerText = data.getUint8(7);
                        document.getElementById('bp').innerText = data.getUint8(8) + "/" + data.getUint8(9);
                    }
                });

                // 3. SEND THE WAKE-UP SYNC COMMAND (FEC7)
                // This is the "Magic" byte that tells the watch to send fitness data
                const writeChar = await fitService.getCharacteristic('0000fec7-0000-1000-8000-00805f9b34fb');
                await writeChar.writeValue(new Uint8Array([0x01])); // 0x01 is the standard "Sync Now" for F5LE
                logger("Sent Sync Command (0x01).");

                // 4. Update Battery
                const batS = await server.getPrimaryService('battery_service');
                const batC = await batS.getCharacteristic('battery_level');
                const batV = await batC.readValue();
                document.getElementById('batt').innerText = batV.getUint8(0) + "%";

            } catch (err) {
                logger("Error: " + err.message);
                document.getElementById('status').innerText = "Status: Sync Failed";
            }
        };
    </script>
</body>
</html>
