<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ANPR Free Tier Test</title>
    <style>
        body { font-family: sans-serif; background: #121212; color: white; text-align: center; padding: 20px; }
        video { width: 100%; max-width: 400px; border-radius: 10px; }
        #log { margin-top: 20px; text-align: left; background: #222; padding: 10px; border-radius: 5px; }
        .success { color: #00ff00; }
    </style>
</head>
<body>
    <h2>ANPR Test (Free Tier)</h2>
    <button id="startBtn" style="padding: 15px 30px; font-size: 18px;">Start Camera</button>
    <br><br>
    <video id="video" autoplay playsinline></video>
    <canvas id="canvas" style="display:none;"></canvas>
    <div id="status">Status: Waiting to start...</div>
    <div id="log"><strong>Log:</strong></div>

    <script>
        const NEW_API_KEY = "AIzaSyBfu5a10239lfdYPB-MRgCAFrToIc7wsNA"; // Use a fresh key!
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const status = document.getElementById('status');
        const log = document.getElementById('log');

        document.getElementById('startBtn').onclick = async () => {
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: "environment" } 
            });
            video.srcObject = stream;
            document.getElementById('startBtn').style.display = 'none';
            runScanner();
        };

        async function runScanner() {
            setInterval(async () => {
                status.innerText = "Status: Capturing frame...";
                const ctx = canvas.getContext('2d');
                canvas.width = 400; canvas.height = 300;
                ctx.drawImage(video, 0, 0, 400, 300);
                
                const base64Image = canvas.toDataURL('image/jpeg', 0.5).split(',')[1];
                status.innerText = "Status: Calling Gemini (Free Tier)...";
                
                await callGemini(base64Image);
            }, 6000); // 6 seconds interval to stay safe on Free Tier
        }

        async function callGemini(base64) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-lite:generateContent?key=${NEW_API_KEY}`;
            const body = {
                contents: [{ parts: [
                    { text: "Return JSON: {'plate': 'TEXT'}. If no plate, 'NONE'." },
                    { inline_data: { mime_type: "image/jpeg", data: base64 } }
                ]}]
            };

            try {
                const resp = await fetch(url, { method: 'POST', body: JSON.stringify(body) });
                const data = await resp.json();
                const text = data.candidates[0].content.parts[0].text;
                const result = JSON.parse(text);

                if (result.plate !== "NONE") {
                    log.innerHTML += `<div class="success">Detected: ${result.plate}</div>`;
                }
            } catch (e) {
                status.innerText = "Status: Error (Check Console)";
                console.error(e);
            }
        }
    </script>
</body>
</html>

